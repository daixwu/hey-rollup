!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self)["bundle-name"]=e()}(this,function(){"use strict";function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function a(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function e(e,t){var i=Object.keys(e);return Object.getOwnPropertySymbols&&i.push.apply(i,Object.getOwnPropertySymbols(e)),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i}function b(a){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?e(o,!0).forEach(function(t){var e,i,n;e=a,n=o[i=t],i in e?Object.defineProperty(e,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[i]=n}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(o)):e(o).forEach(function(t){Object.defineProperty(a,t,Object.getOwnPropertyDescriptor(o,t))})}return a}function S(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],n=!0,a=!1,o=void 0;try{for(var r,s=t[Symbol.iterator]();!(n=(r=s.next()).done)&&(i.push(r.value),!e||i.length!==e);n=!0);}catch(t){a=!0,o=t}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var C={extend:function(n,t){var a=this,e=this.isType(t);if("object"===e)this.forin(t,function(t,e){var i=a.isType(e);"object"!==i&&"array"!==i?n[t]=e:(a.isType(n[t])===i&&null!==n[t]||(n[t]="object"===i?{}:[]),a.extend(n[t],e))});else if("array"===e)for(var i=0;i<t.length;i++)n[i]=t[i];return n},loadImage:function(t,e,i){var n=new Image;0===t.indexOf("http")&&(n.crossOrigin="*"),n.onload=function(){e(n),setTimeout(function(){return n=null},1e3)},n.onerror=function(){i("img load error")},n.src=t},isObject:function(t){return this.isObjFunc(t,"Object")},isBoolean:function(t){return this.isObjFunc(t,"Boolean")},isArr:function(t){return this.isObjFunc(t,"Array")},getImage:function(t,e,i){if("string"==typeof t)this.loadImage(t,function(t){e(t)},i);else{if("object"!==n(t))return void console.log("add image error");e(t)}},forin:function(t,e){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e(i,t[i])},isIos8:function(){var t=window.navigator.userAgent.toLowerCase(),e=/(iPhone|iPad|iPod|iOS)/gi.test(t),i=/(iPad)/gi.test(t);return!!e&&(i?t.match(/cpu os (\d*)/)[1]<9:t.match(/iphone os (\d*)/)[1]<9)},deepCopy:function(t){return JSON.parse(JSON.stringify(t))},isObjFunc:function(t,e){return Object.prototype.toString.call(t)==="[object "+e+"]"},isType:function(t){return Object.prototype.toString.call(t).split(" ")[1].replace("]","").toLowerCase()},getSize:function(t){var e,i;return i="IMG"===t.tagName?(e=t.naturalWidth,t.naturalHeight):"CANVAS"===t.tagName?(e=t.width,t.height):(e=t.offsetWidth,t.offsetHeight),{iw:e,ih:i}}};return function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.ops=Object.assign({width:500,height:500,backgroundColor:""},t),this.canvas=null,this.ctx=null,this.queue=[],this.fn={success:function(){},error:function(){}},this.data={textId:0,text:{},bgConfig:null},this._init()}return function(t,e,i){e&&a(t.prototype,e),i&&a(t,i)}(e,[{key:"_init",value:function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d"),this.ctx.save(),document.querySelector("body").appendChild(this.canvas)}},{key:"background",value:function(t,e){var i=this,n=1<arguments.length&&void 0!==e?e:{type:"origin"};if(t)return t?(n.image=t,this.data.bgConfig=n):n=this.data.bgConfig,this.queue.push(function(){n.color&&i.setBgColor(n.color),C.getImage(n.image,function(t){i._background(t,n)},i.fn.error)}),this;console.error("PrintCanvas error : the init background must has a image.")}},{key:"setBgColor",value:function(t){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}},{key:"_getBgAlign",value:function(t,e,i,n){var a;return"string"==typeof t?"50%"===t||"center"===t?a=n?Math.abs((e-i/n)/2):(i-e)/2:"100%"===t?a=n?Math.abs(e-i/n):Math.abs(i-e):"0%"===t&&(a=0):a="number"==typeof t?t:0,a}},{key:"_background",value:function(t,e){var i,n,a,o,r,s,h,c,u,d=C.getSize(t),l=d.iw,f=d.ih,g=l/f,p=this.canvas.width/this.canvas.height;switch(e.type){case"crop":u=p<g?(a=f*p,o=f,this.canvas.height/f):(o=(a=l)/p,this.canvas.width/l),i=this._getBgAlign(e.left,l,this.canvas.width,u),n=this._getBgAlign(e.top,f,this.canvas.height,u),s=r=0,c=this.canvas.height,h=this.canvas.width;break;case"contain":n=i=0,a=l,o=f,p<g?(c=(h=this.canvas.width)/g,r=e.left||0,s=this._getBgAlign(e.top,c,this.canvas.height,!1)):(h=(c=this.canvas.height)*g,s=e.top||0,r=this._getBgAlign(e.left,h,this.canvas.width,!1));break;case"origin":i=n=0,a=this.canvas.width=l,o=this.canvas.height=f,r=s=0,h=this.canvas.width,c=this.canvas.height;break;default:return void console.error("PrintCanvas error: background type error!")}this.ctx.drawImage(t,i,n,a,o,r,s,h,c),this._next()}},{key:"add",value:function(t,e){var i=this,n=0<arguments.length&&void 0!==t?t:"",a=1<arguments.length&&void 0!==e?e:{},o={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return C.isArr(n)||(n=[{image:n,options:a}]),n.forEach(function(e){i.queue.push(function(){C.getImage(e.image,function(t){i._add(t,i._handleOps(C.extend(o,e.options),t))},i.fn.error)})}),this}},{key:"_add",value:function(t,e){0===e.width&&console.warn("mcanvas warn: the width of mc-element is zero");var i,n,a,o,r,s,h,c,u,d,l,f=C.getSize(t),g=f.iw,p=f.ih,v=e.crop,y=v.x,w=v.y,x=v.width,b=v.height,m=x/b,_=document.createElement("canvas"),O=_.getContext("2d"),j=p<g?g/p:p/g,k=5<1.4*j?5:1.4*j;if(_.width=Math.round(x*k),_.height=Math.round(b*k),C.isIos8()&&(2096<_.width||2096<_.height)?l=1<m?2096/_.width:2096/_.height:(4096<_.width||4096<_.height)&&(l=1<m?4096/_.width:4096/_.height),r=-Math.round(x/2),s=-Math.round(b/2),h=x,c=Math.round(x/m),l){var I=S([_.width,_.height,r,s,h,c].map(function(t){return Math.round(t*l)}),6);_.width=I[0],_.height=I[1],r=I[2],s=I[3],h=I[4],c=I[5]}O.translate(_.width/2,_.height/2),O.rotate(e.pos.rotate),O.drawImage(t,y,w,x,b,r,s,h,c),a=Math.round(e.width*k),o=Math.round(a/m),d=(u=(k-1)*e.width/2)/m,i=Math.round(e.pos.x+a*(1-e.pos.scale)/2-u),n=Math.round(e.pos.y+o*(1-e.pos.scale)/2-d),a*=e.pos.scale,o*=e.pos.scale,this.ctx.drawImage(_,i,n,a,o),_=O=null,this._next()}},{key:"_handleOps",value:function(t,e){var i,n,a=this.canvas.width,o=this.canvas.height,r=C.getSize(e),s=r.iw,h=r.ih,c=s/h,u=this._get(a,s,t.width,"pos"),d=t.crop,l=d.x,f=d.y,g=d.width,p=d.height,v={};v.width=this._get(a,s,g,"crop"),v.height=this._get(o,h,p,"crop"),v.x=this._get(s,v.width,l,"crop"),v.y=this._get(h,v.height,f,"crop"),v.x>s&&(v.x=s),v.y>h&&(v.y=h),i=s-v.x,n=h-v.y,v.width>i&&(v.width=i),v.height>n&&(v.height=n);var y=t.pos,w=y.x,x=y.y,b=y.rotate,m=y.scale;return{width:u,crop:v,pos:{x:this._get(a,u,w,"pos"),y:this._get(o,u/c,x,"pos"),scale:m,rotate:parseFloat(b)*Math.PI/180}}}},{key:"_resetCtx",value:function(){return this.ctx.setTransform(1,0,0,1,0,0),this.ctx.restore(),this}},{key:"text",value:function(t,e){var a=this,o=0<arguments.length&&void 0!==t?t:"",r=1<arguments.length&&void 0!==e?e:{},s=this.canvas.width/20;return this.queue.push(function(){var t={width:300,fontSize:s,fontFamily:"helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",align:"left",color:"#000",lineHeight:1.2*s,type:"fill",lineWidth:1,shadow:{color:null,blur:0,offsetX:0,offsetY:0},pos:{x:0,y:0,rotate:0}},e=C.extend(t,r),i=parseInt(e.fontSize);i&&e.width<i&&(e.width=i);var n=a;setTimeout(function(){n._text(o,e)},0),a._resetCtx()._next()}),this._next(),this}},{key:"_text",value:function(t,n){var a=this;this.data.textId++,this.data.text[this.data.textId]={},n.width=this._get(this.canvas.width,0,n.width,"pos");var e=1,i=0,o=this._get(this.canvas.width,n.width,0,"pos"),r=this._get(this.canvas.height,0,0,"pos")+n.lineHeight;this.data.text[this.data.textId][e]={data:[],lineWidth:0},this.ctx.font="".concat(n.fontSize,"px ").concat(n.fontFamily);var s=this.ctx.measureText(t).width,h=t.replace(/<br>/g,"|");if(s>n.width||-1!==h.indexOf("|"))for(var c=0,u=h.length;c<u;c++){var d=h[c];((s=this.ctx.measureText(d).width)>n.width||"|"===d)&&(i=0,o=this._get(this.canvas.width,n.width,0,"pos"),r+=n.lineHeight,e+=1,this.data.text[this.data.textId][e]={data:[],lineWidth:0},"|"===d)||(this.data.text[this.data.textId][e].data.push(b({context:d,x:o,y:r,width:s},n)),i+=s,o+=s,this.data.text[this.data.textId][e].lineWidth=i)}else this.data.text[this.data.textId][e].data.push(b({context:h,x:o,y:r,width:s},n)),i+=s,o+=s,this.data.text[this.data.textId][e].lineWidth=i;var l,f,g=document.createElement("canvas"),p=g.getContext("2d"),v=this._get(this.canvas.width,n.width,n.pos.x,"pos"),y=this._get(this.canvas.height,0,n.pos.y,"pos");l=g.width=n.width,f=g.height=this._getTextRectHeight(e),console.log("tdh: ",f),console.log("this.data: ",this.data),C.forin(this.data.text[this.data.textId],function(t,e){var i=0;n.lineWidth<n.width&&("center"===n.align?i=(n.width-n.lineWidth)/2:"right"===n.align&&(i=n.width-n.lineWidth)),e.data.forEach(function(t){t.x+=i,a._fillText(p,t)})});var w=v+l/2,x=y+f/2;this.ctx.translate(w,x),this.ctx.rotate(parseFloat(n.pos.rotate)*Math.PI/180),this.ctx.drawImage(g,-l/2,-f/2,l,f)}},{key:"_fillText",value:function(t,e){var i=e.context,n=e.x,a=e.y,o=e.fontSize,r=e.fontFamily,s=e.align,h=e.color,c=e.type,u=e.lineWidth,d=e.shadow,l=e.gradient,f=e.lineHeight,g=d.blur,p=d.offsetX,v=d.offsetY;if(t.font="".concat(o,"px ").concat(r),t.textAlign=s,t.textBaseline="alphabetic",t.lineWidth=u,t.shadowColor=d.color,t.shadowBlur=g,t.shadowOffsetX=p,t.shadowOffsetY=v,l){var y,w,x,b,m=l.gradType,_=l.colorStop;b=(x=1===m?(w=a,(y=n)+e.width):(w=a-f,y=n),a);var O=t.createLinearGradient(y,w,x,b),j=_.length||0;C.forin(_,function(t,e){O.addColorStop(1/j*(+t+1),e)}),t["".concat(c,"Style")]=O}else t["".concat(c,"Style")]=h;t["".concat(c,"Text")](i,n,a),this._resetCtx()}},{key:"_getTextRectHeight",value:function(t){var e=this.data.text[this.data.textId][t].data[0];return e.y+e.lineHeight}},{key:"_get",value:function(t,e,i,n){var a=i;if("string"==typeof i)if(-1!==i.indexOf(":")&&"pos"===n){var o=i.split(":");switch(o[0]){case"left":case"top":a=+o[1].replace("px","");break;case"right":case"bottom":a=t-+o[1].replace("px","")-e}}else a=-1!==i.indexOf("px")?+i.replace("px",""):-1!==i.indexOf("%")?"crop"===n?e*+i.replace("%","")/100:t*+i.replace("%","")/100:"center"===i?(t-e)/2:"origin"===i?e:+i;return Math.round(a)}},{key:"draw",value:function(t){var e,i=this,n={type:"jpeg",quality:.9,success:function(){},error:function(){}};return"function"==typeof t?n.success=t:"jpg"===(n=C.extend(n,t)).type&&(n.type="jpeg"),this.fn.error=n.error,this.fn.success=function(){setTimeout(function(){e=i.canvas.toDataURL("image/".concat(n.type),n.quality),n.success(e)},0)},this._next(),this}},{key:"_next",value:function(){0<this.queue.length?this.queue.shift()():this.fn.success()}},{key:"clear",value:function(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this}}]),e}()});
